import { createRequire } from "module";
import debugFactory from "debug";
import fg from "fast-glob";
import { BREAK, GraphQLSchema, visit } from "graphql";
import { ModuleCache } from "./cache.js";
const schemaCache = new ModuleCache();
const debug = debugFactory("graphql-eslint:schema");
const require2 = createRequire(import.meta.url);
function getSchema(project) {
  const schemaKey = project.schema;
  if (!schemaKey) {
    return null;
  }
  const cache = schemaCache.get(schemaKey);
  if (cache) {
    return cache;
  }
  debug("Loading schema from %o", project.schema);
  const opts = {
    pluckConfig: project.extensions.pluckConfig
  };
  const typeDefs = project.loadSchemaSync(project.schema, "DocumentNode", opts);
  let isFederation = false;
  visit(typeDefs, {
    SchemaExtension(node) {
      const linkDirective = node.directives?.find((d) => d.name.value === "link");
      if (!linkDirective) return BREAK;
      const urlArgument = linkDirective.arguments?.find((a) => a.name.value === "url");
      if (!urlArgument) return BREAK;
      if (urlArgument.value.kind !== "StringValue") return BREAK;
      isFederation = urlArgument.value.value.includes("specs.apollo.dev/federation/");
    }
  });
  let schema;
  if (isFederation) {
    const { buildSubgraphSchema } = require2("@apollo/subgraph");
    schema = buildSubgraphSchema({ typeDefs });
  } else {
    schema = project.loadSchemaSync(project.schema, "GraphQLSchema", opts);
  }
  if (debug.enabled) {
    debug("Schema loaded: %o", schema instanceof GraphQLSchema);
    const schemaPaths = fg.sync(project.schema, { absolute: true });
    debug("Schema pointers %O", schemaPaths);
  }
  schemaCache.set(schemaKey, schema);
  return schema;
}
export {
  getSchema
};
