---
tags: [runtime, execution, build]
depends:
  - @context/blocks/tools/tsconfig-base.md
  - @context/blocks/tools/tsc.md
  - @context/blocks/tools/tsc-alias.md
  - @context/blocks/tools/tsc-esm-fix.md
  - @context/blocks/tools/tsx.md
  - @context/blocks/tools/node.md
---

# TypeScript: Node.js via Compiled JS

Node.js runtime with tsc build pipeline. Compile TypeScript to JavaScript, then run compiled output.

**For:** npm packages, libraries, distributable code

## References

@context/blocks/tools/tsconfig-base.md

## Tool-Specific TypeScript Config

Extends base config with Node.js ESM build settings:

```json
{
  "extends": "./tsconfig.base.json",  // Or inline base settings
  "compilerOptions": {
    // === Module Settings (NodeNext for ESM) ===
    "module": "NodeNext",
    "moduleResolution": "NodeNext",

    // === Build Output ===
    "outDir": "dist",
    "rootDir": "src",
    "sourceMap": true,
    "declaration": true,
    "declarationMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

**Why these settings:**
- `module: NodeNext` - Respects `package.json` `"type": "module"`
- `outDir/rootDir` - Compiled output goes to `dist/`
- `declaration: true` - Generate `.d.ts` for npm packages
- `declarationMap: true` - Enable go-to-definition in consuming projects

## Complete package.json

```json
{
  "name": "my-library",
  "version": "1.0.0",
  "type": "module",

  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },

  "files": ["dist"],

  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc && tsc-alias && tsc-esm-fix",
    "build:clean": "rm -rf dist && pnpm build",
    "start": "node dist/index.js",
    "typecheck": "tsc --noEmit",
    "typecheck:watch": "tsc --noEmit --watch"
  },

  "devDependencies": {
    "typescript": "^5.0.0",
    "tsx": "^4.0.0",
    "tsc-alias": "^1.8.0",
    "tsc-esm-fix": "^3.0.0",
    "@types/node": "^20.0.0"
  }
}
```

**Key points:**
- `tsx` in devDependencies (dev only, not needed in prod)
- `main` + `types` + `exports` - Proper package entry points
- `files: ["dist"]` - Ship only compiled output

## Build Pipeline

```bash
tsc && tsc-alias && tsc-esm-fix
```

**Why this exact order:**

1. **tsc** - Compiles `.ts` → `.js`
   - Outputs to `dist/`
   - Leaves `@/*` imports unchanged
   - Omits `.js` extensions

2. **tsc-alias** - Resolves path aliases
   - Reads `tsconfig.json` paths
   - Rewrites `import { foo } from '@/utils'` → `import { foo } from '../utils'`

3. **tsc-esm-fix** - Adds .js extensions
   - Node ESM requires explicit extensions
   - Rewrites `from '../utils'` → `from '../utils.js'`

### Example Transformation

**Source (src/index.ts):**
```typescript
import { helper } from '@/utils/helper';
import { config } from './config';
```

**After tsc:**
```javascript
import { helper } from '@/utils/helper';   // ❌ Path alias not resolved
import { config } from './config';         // ❌ Missing .js
```

**After tsc-alias:**
```javascript
import { helper } from '../utils/helper';  // ✅ Path resolved
import { config } from './config';         // ❌ Still missing .js
```

**After tsc-esm-fix:**
```javascript
import { helper } from '../utils/helper.js';  // ✅ Complete
import { config } from './config.js';         // ✅ ESM compliant
```

## When to Use

- **npm packages** - Consumers need `.js` + `.d.ts` artifacts
- **Libraries** - Distributable code
- **Production builds** - Pre-compile for faster startup
- **Type declarations** - Need `.d.ts` files for TypeScript consumers

## When NOT to Use

- **Internal tools** - tsx runtime simpler (see @context/foundations/ts-node-tsx.md)
- **Fast prototyping** - Skip build step overhead
- **Monorepo apps not published** - May not need artifacts

## Development Workflow

### Fast Iteration with tsx

During development, skip the build step:

```bash
pnpm dev   # tsx watch src/index.ts
```

tsx handles:
- Path aliases (`@/`) natively
- No `.js` extensions needed
- Instant restarts on file changes
- No type-checking (run `typecheck:watch` in parallel)

### Type-Checking in Parallel

```bash
# Terminal 1
pnpm dev

# Terminal 2
pnpm typecheck:watch
```

### Production Build

```bash
pnpm build   # Full pipeline
pnpm start   # Run compiled code
```

## Folder Structure

```
my-library/
├── src/
│   ├── index.ts           # Main entry point
│   ├── utils/
│   │   └── helper.ts
│   └── types/
│       └── shared.ts
├── dist/                  # Generated by build
│   ├── index.js
│   ├── index.d.ts
│   ├── index.d.ts.map
│   ├── index.js.map
│   └── utils/
│       ├── helper.js
│       └── helper.d.ts
├── package.json
├── tsconfig.json
├── .gitignore
└── README.md
```

## .gitignore

```
dist/
node_modules/
*.log
.env
```

## CI/CD Example

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck
      - run: pnpm test
      - run: pnpm build

      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

## Troubleshooting

### "Cannot find module" after build

**Symptom:** `node dist/index.js` fails with module not found errors.

**Cause:** Path aliases not resolved or missing `.js` extensions.

**Fix:** Ensure all three tools run in order:
```bash
tsc && tsc-alias && tsc-esm-fix
```

### Build is slow

**Optimization:** Use incremental builds:
```json
{
  "compilerOptions": {
    "incremental": true,
    "tsBuildInfoFile": ".tsbuildinfo"
  }
}
```

Add `.tsbuildinfo` to `.gitignore`.

### Type declarations missing

**Symptom:** Published package has no TypeScript support.

**Fix:**
1. Add `"declaration": true` to tsconfig.json
2. Add `"types": "./dist/index.d.ts"` to package.json
3. Ensure `"files": ["dist"]` in package.json

## Alternative Strategies

- **No build step?** Use @context/foundations/ts-node-tsx.md
- **Bun runtime?** Use @context/foundations/ts-bun.md
- **Frontend app?** Use @context/foundations/ts-web-vite.md
