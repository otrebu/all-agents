{
  "$schema": "../docs/planning/schemas/subtasks.schema.json",
  "metadata": {
    "scope": "milestone",
    "milestoneRef": "002-ralph-ðŸ’ª",
    "generatedWith": "subtasks-from-source-v2.md",
    "note": "Predictability-based sizing - comparison test"
  },
  "subtasks": [
    {
      "id": "SUB-025",
      "taskRef": "TASK-REVIEW-001",
      "storyRef": "STORY-001",
      "title": "Update SKILL.md with all 11 reviewer agents",
      "description": "The parallel-code-review skill documentation lists only 5 reviewers but there are 11 reviewer agents. Update the Reviewer Agents table in SKILL.md to include all 11: security-reviewer, data-integrity-reviewer, error-handling-reviewer, test-coverage-reviewer, maintainability-reviewer, dependency-reviewer, documentation-reviewer, accessibility-reviewer, intent-alignment-reviewer, over-engineering-reviewer, performance-reviewer.",
      "done": true,
      "completedAt": "2026-01-26T13:02:19Z",
      "commitHash": "d59a69464d3cac5733480e5bd57157b950e0d4ba",
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 3,
        "reasoning": "Clear what to do (update table), clear how (add rows), similar tables exist in file"
      },
      "acceptanceCriteria": [
        "SKILL.md Reviewer Agents table contains 11 rows (one per agent)",
        "Each agent row has: name, focus area description",
        "Verify: grep -c 'reviewer' .claude/skills/parallel-code-review/SKILL.md | test $(cat) -ge 11"
      ],
      "filesToRead": [
        ".claude/skills/parallel-code-review/SKILL.md",
        ".claude/agents/code-review/"
      ]
    },
    {
      "id": "SUB-026",
      "taskRef": "TASK-REVIEW-001",
      "storyRef": "STORY-001",
      "title": "Document aaa review command in README.md and tools/CLAUDE.md",
      "description": "Two documentation gaps: (1) README.md CLI Tools section doesn't document aaa review command, (2) tools/CLAUDE.md directory structure doesn't include review/ folder. Add both in one subtask since they're related documentation updates with no code changes.",
      "done": true,
      "completedAt": "2026-01-26T16:45:00Z",
      "commitHash": "def6ef6",
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 4,
        "reasoning": "Clear content to add, patterns exist in both files, no research needed. Merged from findings #3 and #4 - same concern (documentation), both deterministic."
      },
      "acceptanceCriteria": [
        "README.md CLI Tools section documents 'aaa review' with --supervised, --headless, --dry-run flags",
        "README.md documents 'aaa review status' subcommand",
        "tools/CLAUDE.md Directory Structure includes review/ folder with index.ts, types.ts",
        "Verify: grep -q 'aaa review' README.md",
        "Verify: grep -q 'review/' tools/CLAUDE.md"
      ],
      "filesToRead": [
        "README.md",
        "tools/CLAUDE.md",
        "tools/src/commands/review/"
      ]
    },
    {
      "id": "SUB-027",
      "taskRef": "TASK-REVIEW-001",
      "storyRef": "STORY-001",
      "title": "Add error logging and Zod validation to review parsing",
      "description": "Two related error handling improvements in review/index.ts: (1) readDiaryEntries silently returns [] on error - add console.warn matching writeDiaryEntry pattern at line 250, (2) parseReviewFindings uses raw JSON.parse without validation - add Zod schema for Finding[] structure. Both improve error handling in the same file.",
      "done": true,
      "completedAt": "2026-01-26T18:30:00Z",
      "commitHash": "d9d26c8",
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 5,
        "reasoning": "Merged findings #6 and #7. Both touch same file, same concern (error handling/validation). Pattern for console.warn exists in file. Zod is standard, Finding type defined in types.ts."
      },
      "acceptanceCriteria": [
        "readDiaryEntries catch block logs warning with chalk.yellow including file path and error message",
        "Pattern matches writeDiaryEntry error handling (lines 250-254)",
        "Zod schema defined for Finding array structure matching types.ts Finding interface",
        "parseReviewFindings uses schema.safeParse() instead of raw JSON.parse",
        "Invalid JSON logs Zod format errors for debugging",
        "Verify: grep -q 'console.warn' tools/src/commands/review/index.ts",
        "Verify: grep -q 'z.object\\|z.array' tools/src/commands/review/index.ts"
      ],
      "filesToRead": [
        "tools/src/commands/review/index.ts",
        "tools/src/commands/review/types.ts"
      ]
    },
    {
      "id": "SUB-028a",
      "taskRef": "TASK-REVIEW-001",
      "storyRef": "STORY-001",
      "title": "Analyze interrogate-review workflow relationship",
      "description": "Research task: The /dev:interrogate command exists alongside the parallel-code-review skill. Determine: (1) What is the purpose of each? (2) Are they currently integrated? (3) When should users use which? Output a documented analysis to inform SUB-028b.",
      "done": true,
      "completedAt": "2026-01-26T21:15:00Z",
      "commitHash": "ca0138e",
      "classification": {
        "knowledgeCertainty": "known-unknown",
        "spikeIndicators": 2,
        "elementCount": 4,
        "reasoning": "Split from finding #12. Original was 'verify and document' which mixes research + implementation. This subtask is research-only with defined output artifact."
      },
      "acceptanceCriteria": [
        "Read and analyzed: .claude/skills/parallel-code-review/SKILL.md",
        "Read and analyzed: .claude/commands/dev/interrogate.md",
        "Read and analyzed: context/workflows/interrogate.md",
        "Output: Analysis documented in completion notes covering: purpose of each, current integration status, recommendation for documentation"
      ],
      "filesToRead": [
        ".claude/skills/parallel-code-review/SKILL.md",
        ".claude/commands/dev/interrogate.md",
        "context/workflows/interrogate.md",
        "docs/planning/VISION.md"
      ],
      "completionNotes": {
        "analysis": {
          "interrogatePurpose": "Ask 'why' - surfaces assumptions, decisions, and confidence levels behind code changes. Focus: developer's decision-making process.",
          "reviewPurpose": "Find issues - identifies bugs, vulnerabilities, anti-patterns across 11 specialized domains. Focus: technical quality of the code itself.",
          "currentIntegration": "NOT integrated - they run independently. Interrogation documented as optional pre-merge checkpoint in complete-feature.md.",
          "relationshipSummary": "Complementary tools: Interrogate surfaces assumptions, Review validates correctness. Both useful for thorough pre-merge validation.",
          "recommendation": "Add 'Related Tools' section to SKILL.md clarifying: interrogate = question decisions (understand intent), review = find problems (verify quality)."
        },
        "comparisonTable": {
          "primaryQuestion": { "interrogate": "Why did you make these choices?", "review": "What problems does this code have?" },
          "target": { "interrogate": "Developer's reasoning/intent", "review": "Code quality/correctness" },
          "analogy": { "interrogate": "Explaining your work", "review": "Having work audited" },
          "bestFor": { "interrogate": "Understanding design decisions", "review": "Finding bugs and anti-patterns" }
        }
      }
    },
    {
      "id": "SUB-028b",
      "taskRef": "TASK-REVIEW-001",
      "storyRef": "STORY-001",
      "title": "Document interrogate vs review distinction",
      "description": "Implementation task (blocked by SUB-028a): Based on analysis findings, add documentation clarifying when to use /dev:interrogate vs aaa review. Add section to SKILL.md or VISION.md explaining: interrogate is for questioning decisions in existing code, review is for finding issues in changes.",
      "done": true,
      "completedAt": "2026-01-26T21:35:00Z",
      "commitHash": "b614b69",
      "blockedBy": ["SUB-028a"],
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 2,
        "reasoning": "After SUB-028a completes, this becomes deterministic: add specific content to specific file based on research findings."
      },
      "acceptanceCriteria": [
        "Documentation added to SKILL.md OR VISION.md (based on SUB-028a recommendation)",
        "Section clearly states: interrogate = questioning decisions, review = finding issues",
        "Section includes guidance on when to use each",
        "Verify: grep -q 'interrogate' in the updated documentation file"
      ],
      "filesToRead": [
        ".claude/skills/parallel-code-review/SKILL.md",
        "docs/planning/VISION.md"
      ]
    },
    {
      "id": "SUB-029",
      "taskRef": "TASK-TIMING-001",
      "storyRef": null,
      "title": "Add timing, skipSummary, and mode types to ralph/types.ts",
      "description": "Extend IterationDiaryEntry with optional timing field, optional mode field, and add skipSummary to BuildOptions. The timing field tracks where time is spent (claudeMs, hookMs, summaryMs, metricsMs). The mode field distinguishes 'headless' vs 'supervised' entries. This is a types-only change that enables the instrumentation in subsequent subtasks.",
      "done": true,
      "completedAt": "2026-01-26T22:10:00Z",
      "commitHash": "aabdbd6",
      "sessionId": "c97c60fb-f0c5-4722-b503-b1e147e95b39",
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 3,
        "reasoning": "Clear interface additions. Exact shapes defined in plan. No dependencies."
      },
      "acceptanceCriteria": [
        "IterationDiaryEntry has optional timing?: { claudeMs: number; hookMs: number; summaryMs: number; metricsMs: number }",
        "IterationDiaryEntry has optional mode?: 'headless' | 'supervised'",
        "BuildOptions has skipSummary: boolean field",
        "All types are exported",
        "Verify: grep -q 'timing?:' tools/src/commands/ralph/types.ts",
        "Verify: grep -q 'skipSummary:' tools/src/commands/ralph/types.ts",
        "Verify: grep -q \"mode?:\" tools/src/commands/ralph/types.ts",
        "TypeScript compiles without errors: bun run typecheck passes"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/types.ts"
      ]
    },
    {
      "id": "SUB-030",
      "taskRef": "TASK-TIMING-001",
      "storyRef": null,
      "title": "Add --skip-summary CLI flag to ralph build",
      "description": "Add -S, --skip-summary option to the ralph build command in index.ts. Pass skipSummary boolean through to runBuild() options. This enables users to skip Haiku summary generation in headless mode to reduce latency and cost.",
      "done": true,
      "completedAt": "2026-01-26T22:45:00Z",
      "commitHash": "2c8631e",
      "sessionId": "c97c60fb-f0c5-4722-b503-b1e147e95b39",
      "blockedBy": ["SUB-029"],
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 3,
        "reasoning": "Follows existing CLI option pattern. Similar to --headless flag. Straightforward Commander option addition."
      },
      "acceptanceCriteria": [
        "ralph build command has .option('-S, --skip-summary', 'Skip Haiku summary generation in headless mode')",
        "options.skipSummary is passed to runBuild() call",
        "aaa ralph build --help shows -S, --skip-summary option",
        "Verify: grep -q 'skip-summary' tools/src/commands/ralph/index.ts",
        "TypeScript compiles without errors"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/index.ts",
        "tools/src/commands/ralph/types.ts"
      ]
    },
    {
      "id": "SUB-031",
      "taskRef": "TASK-TIMING-001",
      "storyRef": null,
      "title": "Instrument timing in post-iteration hook",
      "description": "Add timing instrumentation to runPostIterationHook() in post-iteration.ts. Wrap summary generation and metrics collection with Date.now() timing. Populate the timing field in diary entry. Respect skipSummary option by returning placeholder summary when true. Accept optional mode field and pass it to diary entry.",
      "done": false,
      "blockedBy": ["SUB-029"],
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 5,
        "reasoning": "Clear instrumentation pattern (Date.now() wrappers). Exact locations specified in plan. skipSummary short-circuit is straightforward conditional."
      },
      "acceptanceCriteria": [
        "runPostIterationHook accepts skipSummary in options",
        "runPostIterationHook accepts optional mode: 'headless' | 'supervised' in options",
        "Summary generation is wrapped with timing (summaryMs)",
        "Metrics collection (toolCalls, filesChanged) is wrapped with timing (metricsMs)",
        "Hook total time is tracked (hookMs)",
        "When skipSummary=true, generateSummary is skipped and placeholder used",
        "IterationDiaryEntry written includes timing field with all values",
        "IterationDiaryEntry written includes mode field if provided",
        "Verify: grep -q 'summaryMs' tools/src/commands/ralph/post-iteration.ts",
        "Verify: grep -q 'skipSummary' tools/src/commands/ralph/post-iteration.ts",
        "Verify: grep -q 'mode' tools/src/commands/ralph/post-iteration.ts"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/post-iteration.ts",
        "tools/src/commands/ralph/types.ts"
      ]
    },
    {
      "id": "SUB-032",
      "taskRef": "TASK-TIMING-001",
      "storyRef": null,
      "title": "Track Claude invocation time in build.ts",
      "description": "Wrap invokeClaudeHeadless() call in build.ts with timing to capture claudeMs. Pass claudeMs and skipSummary to runPostIterationHook(). This completes the timing instrumentation chain so diary entries capture all timing phases.",
      "done": false,
      "blockedBy": ["SUB-030", "SUB-031"],
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 3,
        "reasoning": "Simple wrapper pattern around existing invokeClaudeHeadless call. Exact location specified. Follows established timing pattern from SUB-031."
      },
      "acceptanceCriteria": [
        "invokeClaudeHeadless call is wrapped with const claudeStart = Date.now() / claudeMs calculation",
        "claudeMs is passed to runPostIterationHook in options",
        "skipSummary from build options is passed through to hook",
        "Given: aaa ralph build --headless runs, When: iteration completes, Then: logs/iterations.jsonl entry has timing.claudeMs > 0",
        "Verify: grep -q 'claudeMs' tools/src/commands/ralph/build.ts",
        "E2E: Run headless build and verify jq '.timing' logs/iterations.jsonl returns timing object"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/build.ts",
        "tools/src/commands/ralph/post-iteration.ts",
        "tools/src/commands/ralph/types.ts"
      ]
    },
    {
      "id": "SUB-033",
      "taskRef": "TASK-SUPERVISED-001",
      "storyRef": null,
      "title": "Add discoverRecentSession() to session.ts",
      "description": "Add a function to find the most recent Claude session file created after a given timestamp. Uses `find ~/.claude/projects -name '*.jsonl' -newermt ...` to locate session files. Returns { sessionId, path } or null if not found. This enables supervised mode to discover the session after it completes.",
      "done": false,
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 2,
        "reasoning": "Clear implementation pattern. Similar to existing getSessionJsonlPath(). Uses standard find command with timestamp filter."
      },
      "acceptanceCriteria": [
        "discoverRecentSession(afterTimestamp: number) function exists in session.ts",
        "Function returns { sessionId: string; path: string } | null",
        "Uses find command with -newermt to filter by timestamp",
        "Searches in ~/.claude/projects (or CLAUDE_CONFIG_DIR/projects)",
        "Returns most recent session file if multiple match",
        "Function is exported",
        "Verify: grep -q 'discoverRecentSession' tools/src/commands/ralph/session.ts",
        "TypeScript compiles without errors"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/session.ts"
      ]
    },
    {
      "id": "SUB-034",
      "taskRef": "TASK-SUPERVISED-001",
      "storyRef": null,
      "title": "Add post-iteration feedback to supervised mode",
      "description": "Update processSupervisedIteration() in build.ts to: (1) capture startTime before invoking Claude, (2) after session ends, call discoverRecentSession(startTime) to find session file, (3) if found, call runPostIterationHook() with skipSummary: true to generate metrics and diary entry. This gives supervised mode the same feedback display as headless mode.",
      "done": false,
      "blockedBy": ["SUB-029", "SUB-031", "SUB-033"],
      "classification": {
        "knowledgeCertainty": "known-known",
        "spikeIndicators": 0,
        "elementCount": 4,
        "reasoning": "Clear integration pattern. Reuses existing runPostIterationHook(). Only new code is timestamp capture and session discovery call."
      },
      "acceptanceCriteria": [
        "processSupervisedIteration captures startTime = Date.now() before invokeClaudeChat",
        "After session ends, calls discoverRecentSession(startTime)",
        "If session found, calls runPostIterationHook with skipSummary: true",
        "Post-iteration hook receives mode: 'supervised' in options",
        "Metrics box displays after supervised session ends (via renderIterationEnd)",
        "Diary entry written to logs/iterations.jsonl with mode: 'supervised'",
        "Given: aaa ralph build (supervised) runs, When: iteration completes, Then: metrics box shows and diary entry created",
        "Verify: grep -q 'discoverRecentSession' tools/src/commands/ralph/build.ts",
        "Verify: grep -q 'skipSummary.*true' tools/src/commands/ralph/build.ts"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/build.ts",
        "tools/src/commands/ralph/post-iteration.ts",
        "tools/src/commands/ralph/session.ts",
        "tools/src/commands/ralph/types.ts"
      ]
    }
  ],
  "skippedFindings": [
    {
      "finding": 2,
      "title": "Array bounds check - undefined decision",
      "reason": "FALSE POSITIVE - Line 2532 doesn't exist. File is 871 lines, not 2600+."
    },
    {
      "finding": 5,
      "title": "Null safety - regex match",
      "reason": "FALSE POSITIVE - Line 2415 doesn't exist. File is 871 lines."
    },
    {
      "finding": 8,
      "title": "Simplify threshold calculation",
      "reason": "FALSE POSITIVE - Current severity Ã— confidence implementation is reasonable and well-documented."
    },
    {
      "finding": 9,
      "title": "Split index.ts into modules",
      "reason": "FALSE POSITIVE - File is 871 lines, not 2600+. Not large enough to warrant splitting."
    },
    {
      "finding": 10,
      "title": "Break up runHeadlessReview()",
      "reason": "FALSE POSITIVE - File is manageable at 871 lines. Function refactoring not necessary."
    },
    {
      "finding": 11,
      "title": "Break up runReviewStatus()",
      "reason": "FALSE POSITIVE - File is manageable at 871 lines. Function refactoring not necessary."
    }
  ]
}
