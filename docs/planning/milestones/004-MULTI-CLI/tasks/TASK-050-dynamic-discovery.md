---
depends:
  - @docs/planning/milestones/004-MULTI-CLI/stories/004-model-registry.md
  - @docs/planning/milestones/004-MULTI-CLI/tasks/TASK-049-static-registry.md
  - @context/blocks/docs/task-template.md
---

## Task: Dynamic Model Discovery

**Story:** [004-model-registry](../stories/004-model-registry.md)

### Goal
Implement the `aaa ralph refresh-models` command to discover available models from CLI providers and update the dynamic model registry.

### Context
Static models provide a baseline, but new models are released frequently. Dynamic discovery allows users to:
1. Discover newly released models without code changes
2. See what models are available from their installed CLI providers
3. Keep the model registry up to date

The refresh command queries providers that support model listing (starting with OpenCode), generates a new `models-dynamic.ts` file, and merges discovered models with the static baseline.

### Plan
1. Create `tools/src/commands/ralph/providers/models-dynamic.ts` placeholder:
   - Export empty `DISCOVERED_MODELS: ModelInfo[] = []`
   - Add comment: "Auto-generated by `aaa ralph refresh-models`"
2. Create `tools/src/commands/ralph/refresh-models.ts` command:
   - Parse CLI options: `--dry-run`, `--provider`
   - Implement provider-specific discovery functions:
     - `discoverOpencodeModels()` - run `opencode models --json`
   - Aggregate discovered models from all providers (or specified provider)
   - Filter out duplicates (prefer static models)
   - If `--dry-run`: print what would be discovered, exit
   - Generate new `models-dynamic.ts` content
   - Write file to disk
   - Report discovery statistics
3. Add provider discovery capabilities:
   - OpenCode: `opencode models --json` parsing
   - Return array of ModelInfo with discoveredAt timestamp
4. Handle errors gracefully:
   - Provider CLI not installed → skip with warning
   - Provider discovery fails → log error, continue with others
   - No models discovered → informative message
5. Register command in CLI

### Acceptance Criteria
- [x] `aaa ralph refresh-models` command exists and is registered
- [x] `--dry-run` flag shows what would be discovered without writing
- [x] `--provider` flag restricts discovery to specific provider
- [x] OpenCode model discovery works via `opencode models --json`
- [x] Discovered models written to `models-dynamic.ts`
- [x] Dynamic models include discoveredAt timestamp
- [x] Duplicate models (same ID as static) are filtered out
- [x] Errors handled gracefully (missing CLI, discovery failures)
- [x] Success message shows count of discovered models

### Test Plan
- [x] Unit tests for discovery functions with mock provider output
- [x] Test `--dry-run` doesn't modify files
- [x] Test `--provider` filtering
- [x] Test duplicate filtering logic
- [x] Test error handling for missing CLI
- [x] Integration test: mock opencode models output
- [x] Manual test: `aaa ralph refresh-models` discovers models
- [x] Manual test: `aaa ralph refresh-models --dry-run` shows preview

### Scope
- **In:** Refresh command, dynamic model discovery, file generation, CLI options
- **Out:** Static registry (TASK-049), tab completion (TASK-051), model validation (TASK-052)

### Notes
**Command Usage:**
```bash
# Discover models from all supported providers
aaa ralph refresh-models

# Preview what would be discovered (no changes)
aaa ralph refresh-models --dry-run

# Discover only from OpenCode
aaa ralph refresh-models --provider opencode
```

**OpenCode Discovery:**
```typescript
const discoverOpencodeModels = async (): Promise<ModelInfo[]> => {
  // Run: opencode models --json
  // Parse JSON output
  // Map to ModelInfo format
  // Return array with discoveredAt: new Date().toISOString()
};
```

**Dynamic Models File Format:**
```typescript
// providers/models-dynamic.ts
// Auto-generated by `aaa ralph refresh-models`
// Generated: 2026-02-05T10:30:00.000Z

export const DISCOVERED_MODELS: ModelInfo[] = [
  {
    id: 'gemini-2.5-pro',
    provider: 'opencode',
    cliFormat: 'google/gemini-2.5-pro-preview-05-06',
    costHint: 'standard',
    discoveredAt: '2026-02-05'
  },
  // ... more models
];
```

**Merge Strategy:**
1. Collect all discovered models
2. Filter out any with IDs that exist in STATIC_MODELS
3. Sort by provider, then by ID
4. Generate file content
5. Write to `providers/models-dynamic.ts`

**Error Handling:**
- Provider CLI not found: "Warning: opencode CLI not found, skipping..."
- Discovery command fails: "Error discovering opencode models: [error message]"
- No providers available: "No model providers found. Install opencode to discover models."
- No models discovered: "No new models discovered."

**Provider Support Matrix:**
| Provider | Discovery Support | Command |
|----------|------------------|---------|
| opencode | ✅ Yes | `opencode models --json` |
| claude | ❌ No | No model listing command |
| codex | ❌ No | Future |
| gemini | ❌ No | Future |

**Security Note:**
The generated file is committed to git so users get discovered models without running refresh. However, static models always take precedence for well-known IDs.

**Implementation Order:**
1. Create placeholder `models-dynamic.ts`
2. Implement OpenCode discovery
3. Implement refresh command with file generation
4. Add CLI options
5. Wire up to command registry

### Related Documentation
- @docs/planning/milestones/004-MULTI-CLI/stories/004-model-registry.md
- @docs/planning/milestones/004-MULTI-CLI/tasks/TASK-049-static-registry.md
