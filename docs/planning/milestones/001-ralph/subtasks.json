{
  "$schema": "../schemas/subtasks.schema.json",
  "metadata": {
    "scope": "milestone",
    "milestoneRef": "ralph"
  },
  "subtasks": [
    {
      "id": "SUB-001",
      "taskRef": "TASK-007",
      "title": "Create ralph-patterns.md atomic doc",
      "description": "Create context/blocks/construct/ralph-patterns.md documenting the three execution modes (Interactive, Supervised, Headless), CLI + Skill dual entry point pattern (DRY principle), invocation patterns for each mode, and when to use each mode. Update context/README.md to include the new block in the construct section. This serves as the source of truth for Ralph feature development.",
      "done": false,
      "acceptanceCriteria": [
        "context/blocks/construct/ralph-patterns.md exists with all sections from the plan",
        "Document explains the 3 execution modes with table format",
        "Document includes CLI command pattern code snippets",
        "Document includes trust gradient diagram",
        "context/README.md updated to reference ralph-patterns in construct section"
      ],
      "filesToRead": [
        "context/README.md",
        "context/blocks/docs/atomic-documentation.md",
        "docs/planning/tasks/007-three-mode-system-definition.md"
      ]
    },
    {
      "id": "SUB-002",
      "taskRef": "TASK-007",
      "title": "Add Three-Mode System to VISION.md",
      "description": "Add Section 3.1 'Execution Modes (Trust Gradient)' to docs/planning/VISION.md. Define Interactive, Supervised, and Headless modes with a comparison table. Include the trust gradient diagram and reference @context/blocks/construct/ralph-patterns.md for implementation details. Update Section 3 (Operational Modes) to integrate the new naming conventions.",
      "done": false,
      "acceptanceCriteria": [
        "VISION.md has Section 3.1 'Execution Modes (Trust Gradient)'",
        "Section includes comparison table with Mode, Entry, Invocation, User Can Type, Output columns",
        "Trust gradient diagram is included (Low Trust -> High Trust)",
        "References @context/blocks/construct/ralph-patterns.md",
        "Existing Section 3 terminology updated to use new mode names"
      ],
      "filesToRead": [
        "docs/planning/VISION.md",
        "context/blocks/construct/ralph-patterns.md",
        "docs/planning/tasks/007-three-mode-system-definition.md"
      ]
    },
    {
      "id": "SUB-003",
      "taskRef": "TASK-007",
      "title": "Update ROADMAP.md for mode consistency",
      "description": "Update docs/planning/ROADMAP.md to reference the new VISION.md Section 3.1. Add a note in the 'ralph' milestone section that mode consistency is part of milestone deliverables. Ensure terminology throughout uses Interactive/Supervised/Headless naming.",
      "done": false,
      "acceptanceCriteria": [
        "ROADMAP.md references VISION.md Section 3.1",
        "Ralph milestone mentions three-mode system as a key deliverable",
        "Mode terminology is consistent (Interactive, Supervised, Headless)"
      ],
      "filesToRead": [
        "docs/planning/ROADMAP.md",
        "docs/planning/VISION.md"
      ]
    },
    {
      "id": "SUB-004",
      "taskRef": "TASK-007",
      "title": "Add ExecutionMode types and determineMode helper",
      "description": "Add ExecutionMode type ('supervised' | 'headless') to tools/src/commands/ralph/index.ts. Note that 'interactive' is skills-only and not part of CLI. Create determineMode(options) function that returns the correct mode based on CLI flags. Create HeadlessResult interface for JSON output parsing.",
      "done": false,
      "acceptanceCriteria": [
        "ExecutionMode type defined with 'supervised' | 'headless' values",
        "determineMode function accepts options object and returns ExecutionMode",
        "HeadlessResult interface has session_id, result, cost_usd, duration_ms fields",
        "Code follows existing patterns in index.ts"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/index.ts",
        "context/blocks/construct/ralph-patterns.md",
        "tools/CLAUDE.md"
      ]
    },
    {
      "id": "SUB-005",
      "taskRef": "TASK-007",
      "title": "Create invokeClaudeChat helper for Supervised mode",
      "description": "Rename existing invokeClaude() to invokeClaudeChat() in tools/src/commands/ralph/index.ts. This helper spawns 'claude' in chat mode (NOT -p flag), uses stdio: inherit so user can watch AND type if needed, and returns when the chat session exits. This is for supervised mode where user watches each iteration.",
      "done": false,
      "acceptanceCriteria": [
        "invokeClaudeChat() function exists and spawns claude without -p flag",
        "Uses stdio: 'inherit' for interactive terminal access",
        "Does NOT use --output-format json (chat mode needs human-readable output)",
        "Old invokeClaude() calls updated to use invokeClaudeChat()",
        "Function documented with comment explaining supervised mode purpose"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/index.ts",
        "context/blocks/construct/ralph-patterns.md"
      ]
    },
    {
      "id": "SUB-006",
      "taskRef": "TASK-007",
      "title": "Create invokeClaudeHeadless helper",
      "description": "Create invokeClaudeHeadless() function in tools/src/commands/ralph/index.ts. This helper spawns 'claude -p --output-format json', captures stdout, parses JSON response, and returns HeadlessResult. Add support for file logging so user can see what Claude did during autonomous execution.",
      "done": false,
      "acceptanceCriteria": [
        "invokeClaudeHeadless() function exists",
        "Uses claude -p flag with --output-format json",
        "Returns parsed HeadlessResult object",
        "Has optional logFile parameter for file logging",
        "Logs include timestamp, item being processed, and result"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/index.ts",
        "context/blocks/construct/ralph-patterns.md"
      ]
    },
    {
      "id": "SUB-007",
      "taskRef": "TASK-007",
      "title": "Add --supervised and --headless flags to plan commands",
      "description": "Add -s, --supervised and -H, --headless flags to ralph plan commands in tools/src/commands/ralph/index.ts. Update stories, tasks, and subtasks subcommands to use determineMode() for mode selection. Supervised mode calls invokeClaudeChat(), headless mode calls invokeClaudeHeadless(). Remove or alias old --auto flag to --supervised for backward compatibility.",
      "done": false,
      "acceptanceCriteria": [
        "--supervised (-s) flag added to plan stories, tasks, subtasks commands",
        "--headless (-H) flag added to plan stories, tasks, subtasks commands",
        "determineMode() used to select between supervised and headless",
        "Old --auto flag aliased to --supervised or deprecated with warning",
        "Help text explains difference between modes"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/index.ts",
        "context/blocks/construct/ralph-patterns.md"
      ]
    },
    {
      "id": "SUB-008",
      "taskRef": "TASK-007",
      "title": "Update build command for new execution modes",
      "description": "Update ralph build command in tools/src/commands/ralph/index.ts to support --supervised (default) and --headless modes. Update build.sh to handle both modes: supervised spawns chat sessions with stdio:inherit, headless uses -p with JSON output and file logging. Default behavior changes to supervised mode (user watches, can type).",
      "done": false,
      "acceptanceCriteria": [
        "ralph build defaults to supervised mode (chat loop)",
        "--headless (-H) flag runs in JSON + logging mode",
        "build.sh updated to handle mode parameter",
        "Supervised mode: user can see and interact with each iteration",
        "Headless mode: produces JSON output with file logging"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/index.ts",
        "tools/src/commands/ralph/scripts/build.sh",
        "context/blocks/construct/ralph-patterns.md"
      ]
    },
    {
      "id": "SUB-009",
      "taskRef": "TASK-007",
      "title": "Add file logging for headless mode",
      "description": "Implement file logging in build.sh for headless mode. Create log file at logs/ralph-headless-<timestamp>.log that captures Claude's actions so user can review what happened. Include timestamp, subtask being processed, Claude response, and result status in the log.",
      "done": false,
      "acceptanceCriteria": [
        "Headless mode creates log file in logs/ directory",
        "Log filename includes timestamp for uniqueness",
        "Log entries include: timestamp, subtask ID, Claude response summary, status",
        "Log is human-readable (not just raw JSON)",
        "Log path displayed to user when headless mode starts"
      ],
      "filesToRead": [
        "tools/src/commands/ralph/scripts/build.sh",
        "tools/src/commands/ralph/index.ts"
      ]
    },
    {
      "id": "SUB-010",
      "taskRef": "TASK-007",
      "title": "Update shell completions for new flags",
      "description": "Update bash.ts, zsh.ts, and fish.ts completion generators to include --supervised (-s) and --headless (-H) flags for ralph plan and ralph build commands. Ensure completions work for all shells.",
      "done": false,
      "acceptanceCriteria": [
        "bash.ts includes --supervised/-s and --headless/-H for ralph plan/build",
        "zsh.ts includes --supervised/-s and --headless/-H for ralph plan/build",
        "fish.ts includes --supervised/-s and --headless/-H for ralph plan/build",
        "Completion works: typing 'ralph build --' shows new flags"
      ],
      "filesToRead": [
        "tools/src/commands/completion/bash.ts",
        "tools/src/commands/completion/zsh.ts",
        "tools/src/commands/completion/fish.ts"
      ]
    },
    {
      "id": "SUB-011",
      "taskRef": "TASK-007",
      "title": "Add tests for three-mode system",
      "description": "Create tools/tests/e2e/ralph-modes.test.ts with tests for the new three-mode system. Test determineMode() returns correct modes for flag combinations. Test --supervised and --headless flags are recognized. Validate headless JSON output structure matches HeadlessResult interface.",
      "done": false,
      "acceptanceCriteria": [
        "ralph-modes.test.ts file created in tools/tests/e2e/",
        "Tests verify determineMode() logic for all flag combinations",
        "Tests verify --supervised flag accepted by plan and build commands",
        "Tests verify --headless flag accepted by plan and build commands",
        "Tests follow existing pattern in ralph.test.ts"
      ],
      "filesToRead": [
        "tools/tests/e2e/ralph.test.ts",
        "tools/src/commands/ralph/index.ts"
      ]
    }
  ]
}
